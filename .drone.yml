kind: pipeline
name: default

steps:
- name: build image
  image: docker:dind
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  environment:
    SLACK_KEY:
      from_secret: SLACK_KEY
  commands:
  - docker system prune -f
  - docker rm -f bot || true
  - docker rmi -f bot
  - docker build . --build-arg SLACK_KEY --tag bot --force-rm
  - docker run -d --restart always -e VIRTUAL_HOST=bot.allocsoc.net -e LETSENCRYPT_HOST=bot.allocsoc.net -e LETSENCRYPT_EMAIL=kozko2001@gmail.com bot

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock
